# 直播相关

## 音视频基础知识

### 音频

![wKioL1bdXQviw_TBAAAVYm_x3gk862.gif](http://s4.51cto.com/wyfs02/M02/7C/F6/wKioL1bdXQviw_TBAAAVYm_x3gk862.gif)

<B>蓝色代表模拟音频信号，红色的点代表采样得到的量化数值。</B>

采样频率越高，红色的间隔就越密集，记录这一段音频信号所用的数据量就越大，同时音频质量也就越高。

根据奈奎斯特理论，采样频率只要不低于音频信号最高频率的两倍，就可以无损失地还原原始的声音。

通常人耳能听到频率范围大约在20Hz～20kHz之间的声音，为了保证声音不失真，采样频率应在40kHz以上。常用的音频采样频率有：8kHz、11.025kHz、22.05kHz、16kHz、37.8kHz、44.1kHz、48kHz、96kHz、192kHz等。



帧率

​	音频帧：音频跟视频很不一样，视频每一帧就是一张图像，而从上面的正玄波可以看出，音频数据是流式的，本身没有明确的一帧帧的概念，在实际的应用中，为了音频算法处理/传输的方便，一般约定俗成取2.5ms~60ms为单位的数据量为一帧音频。

码率

### 视频

帧率

​	视频帧：每一帧代表一个图像

码率

分辨率

清晰度

## 专业术语

### 转码

### 切片

### 抽帧

## 传输协议

### RTMP

全称Real Time Messaging Protocol（实时消息传输协议）

​	该协议基于 TCP，是一个协议族，包括 RTMP 基本协议及 RTMPT/RTMPS/RTMPE 等多种变种。RTMP 是一种设计用来进行实时数据通信的网络协议，主要用来在 Flash/AIR 平台和支持 RTMP 协议的流媒体/交互服务器之间进行音视频和数据通信。

**用来解决多媒体数据传输流的多路复用（Multiplexing）和分包（packetizing）的问题**

#### 优点

- CDN 支持良好，主流的 CDN 厂商都支持
- 协议简单，在各平台上实现容易

#### 缺点

- 基于 TCP ，传输成本高，在弱网环境丢包率高的情况下问题显著
- 不支持浏览器推送
- Adobe 私有协议，Adobe 已经不再更新

### flv

### hls

### WebRTC

全称Web Real-Time Communication（网页即时通信）

​	是一个支持网页浏览器进行实时语音对话或视频对话的 API。它于 2011 年 6 月 1 日开源并在 Google、Mozilla、Opera 支持下被纳入万维网联盟的 W3C 推荐标准。

![1](https://mars-assets.qiniu.com/wp-content/uploads/2016/09/1-1.jpg)

#### 优点

- W3C 标准，主流浏览器支持程度高
- Google 在背后支撑，并在各平台有参考实现
- 底层基于 SRTP 和 UDP，弱网情况优化空间大
- 可以实现点对点通信，通信双方延时低

#### 缺点

- ICE,STUN,TURN 传统 CDN 没有类似的服务提供

### UDP私有协议

有些直播应用会使用 UDP 做为底层协议开发自己的私有协议，因为 UDP 在弱网环境下的优势通过一些定制化的调优可以达到比较好的弱网优化效果，但同样因为是私有协议也势必有实现问题

#### 优点

- 更多空间进行定制化优化

#### 缺点

- 开发成本高
- CDN 不友好，需要自建 CDN 或者和 CDN 达成协议
- 独立作战，无法和社区一起演进

## 编码

### WHAT？WHY？

什么是编码？为什么要编码？如何编码？

相机采集到的视频数字信号通常是yuv格式，每个像素点需要1.5个Byte来表示，以720p 25fps为例，带宽有263.67Mbps，直播1小时总流量有124.4GB，如有100万人同时观看这场直播，CDN费用会超过1亿元。

- 原始视频数据存储空间大，一个 1080P 的 7 s 视频需要 817 MB

- 原始视频数据传输占用带宽大，10 Mbps 的带宽传输上述 7 s 视频需要 11 分钟

* 而经过 H.264 编码压缩之后，视频大小只有 708 k ,10 Mbps 的带宽仅仅需要 500 ms ，可以满足实时传输的需求，所以从视频采集传感器采集来的原始视频势必要经过视频编码。

h264

h265

x264

x265

### HOW？

<b>编码的核心思想就是去除冗余信息</b>

- 空间冗余：图像相邻像素之间有较强的相关性

- 时间冗余：视频序列的相邻图像之间内容相似

- 编码冗余：不同像素值出现的概率不同

- 视觉冗余：人的视觉系统对某些细节不敏感

- 知识冗余：规律性的结构可由先验知识和背景知识得到

## 直播

![1](https://mars-assets.qiniu.com/wp-content/uploads/2016/08/11.png)

### 传统直播系统解析

#### 1. 采集

1. 手机端采集（IOS、Android）
2. PC

#### 2. 前/预处理

「80% 的主播没有美颜根本没法看。」

美颜、水印、滤镜、模糊特效等处理

#### 3. 编码

1. 硬件兼容性
2.  在高 fps、低 bitrate 和音质画质之间找到平衡

#### 4. 推流（传输）

主播端----->直播平台服务端----->直播平台边缘节点（CDN）----->观众端

##### 传统CDN

![2](https://mars-assets.qiniu.com/wp-content/uploads/2016/09/2-1.png)

CDN分类：

- 骨干节点
  - 中心节点
  - 区域节点
- POP节点
  - 边缘节点

逻辑上来讲，骨干节点主要负责内容分发和边缘节点未命中时进行回源，POP 节点主要负责提供给用户就近的内容访问服务。但如果 CDN 网络规模较大，边缘节点直接向中心节点回源会给中间层的核心设备造成的压力过大，在物理上引入区域节点，负责一个地理区域的管理，保存部分热点数据。

<b>传统CDN的弊端：</b>

​	撒打算打算的

##### 基于P2P的CDN网络

![4](https://mars-assets.qiniu.com/wp-content/uploads/2016/09/4-1.png)



#### 5. 转码

为了让主播推上来的流适配各个平台端、各种不同协议，需要在服务端做一些流处理工作，比如转码成不同格式支持不同协议如 RTMP、HLS 和 FLV，一路转多路流来适配各种不同的网络状况和不同分辨率的终端设备。

#### 6. 解码&渲染

即音视频的播放

## 直播架构

## 改进

腾讯云监控





